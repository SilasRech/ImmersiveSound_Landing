<!DOCTYPE html>
<html>

<head>
    <title>Immersive Sound Demo</title>
    <script src="//code.jquery.com/jquery-3.0.0.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r123/three.min.js"></script>
    <script src="./js/OrbitControls.js"></script>
    <script src="./js/ambisonics.umd.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/app.js"></script>

</head>
<body>
  <!--Introdution-->
  <header> Welcome to the Immersive Sound Demo

  </header>

  <div id='info'>
  <p>
    You can rotate the scene by just clicking and rotating jupiter.
    <br>
    Click on Reset to hear the intended sound direction again.
  </p>
  </div>

  <div id='loading_info'>
    <p > Currently Loading audio and filters... </p>
      <i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>
    <span class="sr-only">Loading...</span>
  </div>

  <!--Start Stop-->
  <div id='div-play-stop-buttons'>
    <button id="play" disabled> PLAY
      <i class="fas fa-play-circle"></i>
    </button>
    <button id="stop" disabled> STOP
      <i class="fas fa-stop-circle"></i>
    </button>
  </div>

  <!--Volume-->
  <div id='div-volume'>
  <label for="volume-slider">Volume</label> &nbsp;
  <input id="volume-slider" type="range" min="0.1" max="10" value="1" step="0.1" />
  </div>

  <!--Reset Positoin-->
  <div id='div-reset'>
    <button id="reset">Reset Rotation
      <i class="fas fa-dot-circle"></i>
    </button>
  </div>
  <script>
    var rotation_vector = [0, 0, 0];

    // Create Scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
    const renderer = new THREE.WebGLRenderer({antialias: true, alpha: true });

    renderer.setSize(window.innerWidth, window.innerHeight );
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = 0;
    renderer.setClearColor( 0x000000, 0 ); // the default
    document.body.appendChild(renderer.domElement);

    // Create Textures for Planets and Stars
    const texture = new THREE.TextureLoader().load("./src/images/jupiter_texture.jpg");
    const texture_stars = new THREE.TextureLoader().load(".src/images/images/galaxy_starfield.png");

    //Lights
    var ambientLight = new THREE.AmbientLight(0xf1f1f1, 0.5);
    scene.add(ambientLight);

    var spotLight = new THREE.DirectionalLight(0xffffff, 0.5);
    spotLight.position.set(50,50,50);
    scene.add(spotLight);

    // Add Earth to the Scene
    var earthGeometry = new THREE.SphereGeometry(6, 32, 32);
    var earthMaterial = new THREE.MeshPhongMaterial({
     map: texture,
     color: 0xf2f2f2,
     specular: 0xbbbbbb,
     shininess: 2
    });
    var earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);

    // Stars
    var star = new THREE.SphereGeometry(0.1, 3, 3);
    starMaterial = new THREE.MeshBasicMaterial( {color: 0xffffff} );

    stars = [];
    for(var i = 0; i < 300; i++){
      stars[i] = new THREE.Mesh(star, starMaterial);
      stars[i].position.x = 100*Math.random() - 50;
      stars[i].position.y = 100*Math.random() - 50;
      stars[i].position.z = 100*Math.random() - 50;
      scene.add(stars[i]);
    };

    // Add the Stars to the scene
    //var starGeometry = new THREE.SphereGeometry(1000, 50, 50);
    //var starMaterial = new THREE.MeshPhongMaterial({
    // map: texture_stars,
    //   side: THREE.DoubleSide,
    //  shininess: 0
     //});
    //var starField = new THREE.Mesh(starGeometry, starMaterial);
    //scene.add(starField);

    // Create Control for Camera andle and save default setting for resets
    controls = new THREE.OrbitControls(camera, renderer.domElement)

    camera.position.y = 0;
    camera.position.z = 40;
    var camToSave = {};
    camToSave.position = camera.position.clone();
    camToSave.rotation = camera.rotation.clone();
    camToSave.controlCenter = controls.target.clone();

    // Animate the Objects
    const animate = () => {
    requestAnimationFrame( animate );
    camera.updateMatrixWorld();

    var vector = camera.position.clone();
    var rotation_vector = calculateAngles(vector);

    for(var i = 0; i < 300; i++){
      stars[i].position.x -= 0.005 - vector.x * 0.0005 ;
    }

    //Update the Rotationvector for the Ambisonics
    rotator.yaw = rotation_vector[0];
    rotator.pitch = rotation_vector[1];
    rotator.roll = rotation_vector[2];
    rotator.updateRotMtx();

    renderer.render( scene, camera );
    };
    animate();


    //Automatically Resize the Window
    window.addEventListener( 'resize', onWindowResize, false );
    function onWindowResize(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
  }
  ///////////////
    // SET-UP GUI AND USER INPUT
    $(document).ready(function() {

        var volumeSlider = document.getElementById('volume-slider');
        volumeSlider.addEventListener('input', function(input) {
            gainOut.gain.value = volumeSlider.value;
        });

    });

    // function called when audiocontext.decodeAudioData fails to decode a given audio file, e.g. in Safari with .ogg vorbis format
    function onDecodeAudioDataError(error) {
        var url = 'hjre';
      alert("Browser cannot decode audio data..." + "\n\nError: " + error + "\n\n(If you re using Safari and get a null error, this is most likely due to Apple's shady plan going on to stop the .ogg format from easing web developer's life :)");
    }

    $.holdReady( false );
    </script>
    </div>
</body>

</html>
